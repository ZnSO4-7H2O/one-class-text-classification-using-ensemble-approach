{"title": "Predicting Organic Reaction Outcomes with Weisfeiler-Lehman Network", "tag": ["cs.LG", "cs.AI", "stat.ML"], "abstract": "The prediction of organic reaction outcomes is a fundamental problem in computational chemistry. Since a reaction may involve hundreds of atoms, fully exploring the space of possible transformations is intractable. The current solution utilizes reaction templates to limit the space, but it suffers from coverage and efficiency issues. In this paper, we propose a template-free approach to efficiently explore the space of product molecules by first pinpointing the reaction center -- the set of nodes and edges where graph edits occur. Since only a small number of atoms contribute to reaction center, we can directly enumerate candidate products. The generated candidates are scored by a Weisfeiler-Lehman Difference Network that models high-order interactions between changes occurring at nodes across the molecule. Our framework outperforms the top-performing template-based approach with a 10\\% margin, while running orders of magnitude faster. Finally, we demonstrate that the model accuracy rivals the performance of domain experts.", "text": "prediction organic reaction outcomes fundamental problem computational chemistry. since reaction involve hundreds atoms fully exploring space possible transformations intractable. current solution utilizes reaction templates limit space suffers coverage efﬁciency issues. paper propose template-free approach efﬁciently explore space product molecules ﬁrst pinpointing reaction center nodes edges graph edits occur. since small number atoms contribute reaction center directly enumerate candidate products. generated candidates scored weisfeiler-lehman difference network models high-order interactions changes occurring nodes across molecule. framework outperforms top-performing template-based approach margin running orders magnitude faster. finally demonstrate model accuracy rivals performance domain experts. fundamental problems organic chemistry prediction products form result chemical reaction products determined unambiguously simple reactions major challenge many complex organic reactions. indeed experimentation remains primary manner reaction outcomes analyzed. time consuming expensive requires help experienced chemist. empirical approach particularly limiting goal automatically designing efﬁcient reaction sequences produce speciﬁc target molecule problem known chemical retrosynthesis viewing molecules labeled graphs atoms propose formulate reaction prediction task graph transformation problem. chemical reaction transforms input molecules molecules performing graph edits reactant molecules adding edges and/or eliminating existing ones. given typical reaction involve atoms fully exploring possible transformations intractable. computational challenge reduce space possible edits effectively select product among resulting candidates. state-of-the-art solution based reaction templates reaction template speciﬁes molecular subgraph pattern applied corresponding graph transformation. since multiple templates match reactants another model trained ﬁlter candidate products using standard supervised approaches. drawbacks approach coverage scalability. large number templates required ensure least reconstitute correct product. templates currently either hand-crafted experts generated reaction databases heuristic algorithms example coley extracts unique reaction templates database million reactions. beyond coverage applying figure example reaction reaction center highlighted green. bond deleted connected aromatic bonds form ring. corresponding reaction template consists reaction center nearby functional groups explicitly specify context. template involves graph matching makes examining large numbers templates prohibitively expensive. current approach therefore limited small datasets limited types reactions. paper propose template-free approach learning identify reaction center small atoms/bonds change reactants products. datasets average reactant molecules directly participate reaction. small size reaction centers together additional constraints bond formations enables directly enumerate candidate products. forward-prediction approach divided parts learning identify reaction centers learning rank resulting enumerated candidate products. technical approach builds neural embedding weisfeiler-lehman isomorphism test. incorporate speciﬁc attention mechanism identify reaction centers leveraging distal chemical effects accounted related convolutional representations moreover propose novel weisfeiler-lehman difference network learn represent efﬁciently rank candidate transformations reactants products. evaluate method datasets derived uspto compare methods current performing system method achieves accuracy datasets outperforming baseline approach running times faster. finally demonstrate model outperforms domain experts large margin. template-based approach existing machine learning models product prediction mostly built reaction templates. approaches differ templates speciﬁed ﬁnal product selected multiple candidates. instance learns select among pre-speciﬁed hand-encoded templates given ﬁngerprints reactants reagents. work developed narrow range chemical reaction types among ﬁrst implementations demonstrates potential neural models analyzing chemical reactions. recent work demonstrated power neural methods broader reactions. instance segler waller coley data-driven approach obtain large templates employ neural model rank candidates. difference approaches representation reaction. segler waller molecules represented based morgan ﬁngerprints coley represents reactions features atoms bonds reaction center. however template-based architecture limits methods scaling larger datasets diversity. template-free approach kayala also presented template-free approach predict reaction outcomes. approach differs several ways. first kayala operates mechanistic level identifying elementary mechanistic steps rather overall transformations reactants products. since reactions consist many mechanistic steps approach requires multiple predictions fulﬁll entire reaction. approach operates graph level figure overview approach. train model identify pairwise atom interactions reaction center. pick atom pairs enumerate chemically-feasible bond conﬁgurations atoms. bond conﬁguration generates candidate outcome reaction. another model trained score candidates true product. predicting transformations reactants products single step. second mechanistic descriptions reactions given existing reaction databases. therefore kayala created training based mechanistic-level template-driven expert system. contrast model learned directly real-world experimental data. third kayala uses feed-forward neural networks atoms graphs represented molecular ﬁngerprints additional hand-crafted features. approach builds graph neural networks encode graph structures. molecular graph neural networks question molecular graph representation issue reaction modeling. computational chemistry molecules often represented morgan fingerprints boolean vectors reﬂect presence various substructures given molecule. duvenaud developed neural version morgan fingerprints convolution operation aggregates features neighboring nodes replacement ﬁxed hashing function. representation expanded kearnes graph convolution models. consider different architecture molecular graph viewed latent variable graphical model. recurrent model derived belief propagation-like algorithms. gilmer generalized previous architectures message-passing network applied quantum chemistry. closest work weisfeiler-lehman kernel network proposed recurrent model derived weisfeiler-lehman kernel produces isomorphism-invariant representations molecular graphs. paper enhance representation capture graph transformations reaction prediction. approach bypasses reaction templates learning reaction center identiﬁer. speciﬁcally train neural network operates reactant graph predict reactivity score every pair atoms reaction center selected picking small number atom pairs highest reactivity scores. identifying reaction center generate possible product candidates enumerating possible bond conﬁgurations atoms reaction center subject chemical constraints. train another neural network rank product candidates correct reaction outcome ranked highest overall pipeline summarized figure describing modules detail formally deﬁne concepts used throughout paper. chemical reaction chemical reaction pair molecular graphs called reactants products. molecular graph described a··· atoms b··· associated bonds varying types note multiple connected components since multiple molecules comprising reactants. reactions used training atom-mapped atom product graph unique corresponding atom reactants. reaction center reaction center atom pairs bond type differs words reaction center minimal graph edits needed transform reactants products. since reported reactions training atom-mapped reaction centers identiﬁed automatically given product. given reaction atom pair associated reactivity label specifying whether relation differs reactants products. label determined comparing help atom-mapping. predict label basis learned atom representations incorporate contextual cues surrounding chemical environment. particular build weisfeiler-lehman network shown superior results learned graph representations narrower setting predicting chemical properties individual molecules inspired weisfeiler-lehman isomorphism test labeled graphs. architecture designed embed computations inherent isomorphism testing generate learned isomorphism-invariant representations atoms. isomorphism test idea isomorphism test repeatedly augment node labels sorted node labels neighbor nodes compress augmented labels short labels. initial labeling atom element. iteration label augmented element labels neighbors. multi-set label compactly represented label hash function. ﬁnal label atom molecular graph represented bond type graphs said isomorphic representations same. number distinct labels grows exponentially number iterations network discrete relabeling process directly generalize continuous feature vectors. instead appeal neural networks continuously embed computations inherent test. analogous continuous relabeling function. node neighbor nodes node features edge features relabeled according present models predict reactivity local global models. local model based directly atom representations predicting label yuv. global model hand selectively incorporates distal chemical effects goal capturing fact atoms outside reaction center necessary reaction occur. example reaction center inﬂuenced certain reagents. incorporate distal effects global model attention mechanism. local model atom representations atoms respectively returned wln. predict reactivity score passing another neural network sigmoid function additional feature vector encodes auxiliary information pair whether atoms different molecules type bond connects them. global model attention score atom atom global context representation atom calculated weighted reactant atoms weight comes attention module note attention obtained sigmoid rather softmax non-linearity since multiple atoms relevant particular atom training models trained minimize following loss function predict label independently large number variables. given reaction atoms need predict reactivity score pairs. quadratic complexity prohibits adding higher-order dependencies different pairs. nonetheless found independent prediction yields sufﬁciently good performance. select atom pairs highest predicted reactivity score designate them collectively reaction center. candidate products obtained enumerating possible bond conﬁguration changes within set. resulting candidate products exponential many ruled invoking additional constraints. example every atom maximum number neighbors connect also leverage statistical bias reaction centers unlikely consist disconnected components multi-step reactions exist violate connectivity constraint. show candidates arising procedure compact arising templates without sacriﬁcing coverage. candidate ranking training candidate ranking consists lists reactants known product p··· enumerated candidate products. goal learn scoring function ranks highest known product challenge ranking candidate products representational. must learn represent manner focus difference reactants products also incorporating necessary chemical contexts surrounding changes. propose alternative models score candidate pair ﬁrst model naively represents reaction summing difference vectors atom representations obtained associated connected components. second improved model called wldn takes account higher order interactions differences vectors. recall reactants products atom-mapped refer atom. pooling operation simple difference vectors resulting single vector pair. vector another neural network score candidate product weisfeiler-lehman difference network instead simply summing difference vectors wldn operates another graph called difference graph. difference graph deﬁned molecular graph atoms bonds atom feature vector replaced operating difference graph several beneﬁts. first atom feature vector deviates zero close reaction center thus focusing processing reaction center immediate context. second explicates neighbor dependencies difference vectors. wldn maps graph-based representation ﬁxed-length vector applying separately parameterized data source data experiments used reactions uspto granted patents collected lowe removing duplicates erroneous reactions obtained reactions refer paper uspto. dataset divided training development testing purposes. addition comparison purposes report results subset reaction dataset used coley selected subset include reactions covered common templates. follow split training development testing. setup reaction center identiﬁcation output component consists atom pairs highest reactivity scores. compute coverage proportion reactions atom pairs true reaction center predicted model i.e. recorded product found model-generated candidate set. model features reﬂect basic chemical properties atoms bonds. atom-level features include elemental identity degree connectivity number attached hydrogen atoms implicit valence aromaticity. bond-level features include bond type whether conjugated whether bond part ring. local global models build upon weisfeiler-lehman network unrolled depth models optimized adam learning rate decay factor setup candidate ranking goal evaluation determine whether model select correct product candidates derived reaction center. ﬁrst compare model accuracy top-performing template-based approach coley approach employs frequency-based heuristics construct reaction templates uses neural model rank derived candidates. explained above scalability issues associated baseline compare uspto-k authors restricted contain examples instantiated popular templates. experiment candidate generation achieves coverage yields candidates reaction. compare standard representation counterpart difference networks train setup uspto-k ﬁxing number parameters next evaluate model uspto large scale evaluation. candidate generation report result best model architecture. finally factorize coverage candidate selection accuracy candidate ranking consider evaluation scenarios candidate list derived reaction center; candidate list augmented true product found. latter setup marked reaction center identiﬁcation table reports coverage model compared real reaction core. clearly coverage depends number atom pairs higher coverage larger values results demonstrate even model achieves high coverage results also clearly demonstrate advantage global model local consistent across experiments. superiority global model line well-known fact reactivity depends immediate local environment surrounding reaction center. presence certain functional groups reaction center promote inhibit different modes reactivity. moreover reactivity often inﬂuenced presence reagents separate molecules directly contribute atoms product. consideration factors necessitates model account long-range dependencies atoms. figure depicts example observed reactivity attributed presence reagent molecule completely disconnected reaction center itself. local model fails anticipate reactivity global accurately predicts reaction center. attention highlights reagent molecule determinant context. figure reaction reduces carbonyl carbon amide removing bond reactivity site would highly unlikely without presence borohydride global model correctly predicts bond susceptible change local model even include predictions. attention global model show atoms determinants atom predicted reactivity. example reaction occurs carbon carbonyl group also adjacent phenyl group corresponding template explicitly requires carbonyl part phenyl ring context although reactivity case require additional speciﬁcation phenyl group candidate generation compare coverage generated candidates templatebased model. table shows model generates average candidates reaches coverage template-based baseline requires templates extracted training data achieve coverage average candidates example. weakness baseline model explained difﬁculty deﬁning general heuristics extract templates reaction examples. possible deﬁne different levels speciﬁcity based extent atoms surrounding reaction center included generalized introduces unavoidable trade-off generality speciﬁcity figure illustrates reaction example corresponding template rare adjacency reaction center carbonyl group phenyl ring. adjacency either group inﬂuence reactivity included part template although reactivity case require additional speciﬁcation phenyl group. massive number templates required high coverage serious impediment template approach template application requires solving subgraph isomorphism problem. speciﬁcally takes average seconds apply templates test instance method takes less times faster. candidate ranking table reports performance product prediction task. since baseline templates optimized test coverage compare performance models correct product added wldn). model clearly outperforms baseline wide margin. even compared candidates automatically computed reaction center wldn outperforms baseline top- accuracy. results also demonstrate wldn model consistently outperforms model. consistent intuition modeling higher order dependencies difference vectors advantageous simply summing them. table also shows model performance improves tested full uspto dataset. analyze model performance based frequency underlying transformation reﬂected number template precedents. figure group test instances according frequency report coverage global model mean reciprocal rank wldn model them. expected approach achieves highest performance frequent reactions. however maintains reasonable coverage ranking accuracy even rare reactions particularly challenging template-based methods. randomly selected reaction examples test template popularity intervals figure asked chemists predict outcome given reactants. average accuracy across performers model achieves accuracy close best individual performer scored table human model performance reactions randomly selected uspto test cover diverse range reaction types. ﬁrst chemists rich experience organic chemistry last graduate students chemical engineering organic chemistry concepts regularly less formal training. proposed novel template-free approach chemical reaction prediction. instead generating candidate products reaction templates ﬁrst predict small atoms/bonds reaction center produce candidate products enumerating possible bond conﬁguration changes within set. compared template based approach framework runs times faster allowing scale much larger reaction databases. reaction center identiﬁer candidate ranking model build weisfeiler-lehman network variants learn compact representation graphs reactions. hope work encourage computer scientists chemists explore fully data driven approaches task. thank jamison darsh shah karthik narasimhan reviewers helpful comments. also thank members department chemistry department chemical engineering participated human benchmarking study. work supported darpa make-it program contract wnf---. references jonathan chen pierre baldi. electron left behind rule-based expert system predict chemical reactions reaction mechanisms. journal chemical information modeling clara christ matthias zentgraf kriegl. mining electronic laboratory notebooks analysis retrosynthesis reaction based enumeration. journal chemical information modeling david duvenaud dougal maclaurin jorge iparraguirre rafael bombarell timothy hirzel alán aspuru-guzik ryan adams. convolutional networks graphs learning molecular ﬁngerprints. advances neural information processing systems pages markus hartenfeller martin eberle peter meier cristina nieto-oberhuber karl-heinz altmann gisbert schneider edgar jacoby steffen renner. collection robust organic synthesis reactions silico molecule design. journal chemical information modeling steven kearnes kevin mccloskey marc berndl vijay pande patrick riley. molecular graph convolutions moving beyond ﬁngerprints. journal computer-aided molecular design james zsolt zsoldos aniko simon darryl reid yang sing yoong khew peter johnson sarah major robert wade howard ando. route designer retrosynthetic analysis tool utilizing automated retrosynthetic rule generation. chem. inf. model. issn wengong regina barzilay tommi jaakkola. deriving neural architectures sequence graph kernels. proceedings international conference machine learning sara szymkuc gajewska tomasz klucznik karol molga piotr dittwald michał startek michał bajczyk bartosz grzybowski. computer-assisted synthetic planning beginning. angew. chem. int. issn ./anie.. http//dx.doi.org/./anie.. wendy warr. short review chemical reaction database systems computer-aided synthesis design reaction prediction synthetic feasibility. molecular informatics describe detail human evaluation results table evaluation dataset consists eight groups deﬁned reaction template popularity binned figure instances selected randomly uspto test set. invited total chemists predict product given reactants groups. table human model performance reactions randomly selected uspto test cover diverse range reaction types. ﬁrst experts rich experience organic chemistry last graduate students chemical engineering organic chemistry concepts regularly less formal training. model performs expert chemist level terms accuracy. individual accuracies human performers wldn model. human answers scored exact matches imprecise matches difference predicted product recorded product small enough warrant half-point. wldn model performs expert level.", "year": 2017}