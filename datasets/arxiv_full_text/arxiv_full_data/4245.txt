{"title": "Dilated FCN for Multi-Agent 2D/3D Medical Image Registration", "tag": ["cs.CV", "cs.AI"], "abstract": "2D/3D image registration to align a 3D volume and 2D X-ray images is a challenging problem due to its ill-posed nature and various artifacts presented in 2D X-ray images. In this paper, we propose a multi-agent system with an auto attention mechanism for robust and efficient 2D/3D image registration. Specifically, an individual agent is trained with dilated Fully Convolutional Network (FCN) to perform registration in a Markov Decision Process (MDP) by observing a local region, and the final action is then taken based on the proposals from multiple agents and weighted by their corresponding confidence levels. The contributions of this paper are threefold. First, we formulate 2D/3D registration as a MDP with observations, actions, and rewards properly defined with respect to X-ray imaging systems. Second, to handle various artifacts in 2D X-ray images, multiple local agents are employed efficiently via FCN-based structures, and an auto attention mechanism is proposed to favor the proposals from regions with more reliable visual cues. Third, a dilated FCN-based training mechanism is proposed to significantly reduce the Degree of Freedom in the simulation of registration environment, and drastically improve training efficiency by an order of magnitude compared to standard CNN-based training method. We demonstrate that the proposed method achieves high robustness on both spine cone beam Computed Tomography data with a low signal-to-noise ratio and data from minimally invasive spine surgery where severe image artifacts and occlusions are presented due to metal screws and guide wires, outperforming other state-of-the-art methods (single agent-based and optimization-based) by a large margin.", "text": "markov decision process formulation image registration recently introduced resulted signiﬁcant robustness improvement original formulation however three major limitations make ineffective registration clinical setup. first requires rough location size target object registered prior order extract local region around target agent’s observation. however registration location size target object vary signiﬁcantly x-ray images variations c-arm geometry imaging protocols collimation factors. second could various artifacts interference coming medical devices x-ray images simulation training samples practical. therefore auto attention mechanism needed order able inherently detect regions reliable visual cues drive registration mechanism provided third training data need sampled extensively registration environment high associated high computational cost. fact million samples needed reported even using location prior knowledge reduce since data sampling grows exponentially without location prior knowledge computational cost would prohibitively high registration problem. paper propose multi-agent system auto attention mechanism address three limitations agent-based registration apply challenging registration application minimally invasive spine surgery. particular multiple agents employed observe multiple regions image system adaptively favors proposals regions distinct visual cues registration. furthermore propose policy network architecture separate encoding ﬁxed moving images dilated fully convolutional network image registration align volume x-ray images challenging problem ill-posed nature various artifacts presented x-ray images. paper propose multi-agent system auto attention mechanism robust efﬁcient image registration. speciﬁcally individual agent trained dilated fully convolutional network perform registration markov decision process observing local region ﬁnal action taken based proposals multiple agents weighted corresponding conﬁdence levels. contributions paper threefold. first formulate registration observations actions rewards properly deﬁned respect x-ray imaging systems. second handle various artifacts x-ray images multiple local agents employed efﬁciently fcn-based structures auto attention mechanism proposed favor proposals regions reliable visual cues. third dilated fcn-based training mechanism proposed signiﬁcantly reduce degree freedom simulation registration environment drastically improve training efﬁciency order magnitude compared standard cnn-based training method. demonstrate proposed method achieves high robustness spine cone beam computed tomography data signal-to-noise ratio data minimally invasive spine surgery severe image artifacts occlusions presented metal screws guide wires outperforming state-of-the-art methods large margin. goal medical image registration degree freedom pose volume mangnetic resonance imaging etc) align projections given xray images. reliable registration enabler image-guided surgeries modern operating rooms. brings measurement plannings done pre-operative data operating room fuse intra-operative live x-ray images. used provide augmented reality image guidance surgery provide navigation robotic surgery. despite registration copyright association advancement artiﬁcial intelligence rights reserved. figure example x-ray images corresponding digitally reconstructed radiographs ﬁrst four x-ray images clinical data spine surgery contain various highly opaque metal objects different field-of-views last three x-ray images cbct data relatively small dynamic range. based training strategy train observation regions back propagation. strategy signiﬁcantly reduces dofs registration environment result training efﬁciency improved order magnitude compared standard cnn-based training method. proposed structure also naturally supports multi-agent system application phase efﬁcient registration. demonstrate severe image artifacts occlusions e.g. metal screws guide wires proposed method signiﬁcantly outperforms single agent-based method state-of-the-art optimizationbased methods reducing gross failure rate fold. optimization-based registration widely adopted formulation registration solve optimization problem minimize cost function quantiﬁes quality alignment images registered success approaches depends global optimization cost function. existing image-based cost functions mostly based level metrics e.g. mutual information cross correlation gradient correlation etc. metrics compare images directly pixel level without understanding higher level structures image. result images signal-tonoise ratio and/or severe image artifacts like examples shown fig. often numerous local minima makes extremely challenging locate global solution using mathematical optimization strategy e.g. powell’s method nelder-mead bfgs cma-es. although global optimization methods e.g. simulated annealing genetic algorithm require comprehensive sampling parameter space leads prohibitively high computational cost. attempts made learning-based image registration several attempts made recently tackle registration problems using learning-based approaches. hand crafted features simple regression modules like multi-layer perceptron linear regression proposed regress registration parameters cnn-based regression approach introduced solve registration device pose estimation x-ray images later domain adaptation scheme proposed improve performance generalization model unseen real data. range image descriptor learned differentiate pose object used pose estimation. cnn-based methods improve robustness registration limited registering highly opaque objects ﬁxed shape described model aimed explicitly modeling appearance-pose relationship. therefore cannot solve registration anatomical structures varying shapes across patients. learning-based approaches also explored image registration goal spatial transformation align images dimension. unsupervised learning using proposed extract features deformable registration. features however extracted separately image pairs therefore optimal registration purpose. optical estimation images proposed using supervised learning learnable module called spatial transformer network introduced focus accurate alignment images rough transformation single input image canonical form. recent work rigid-body image registration formulated policy network trained perform image registration motivated work design registration system utilizing multiple agents coupled auto attention mechanism high robustness train agent using dilated fcn-based strategy high efﬁciency. intensity synthetic x-ray image point line connecting x-ray source point parameterized geometric transformation volume. projection image referred computed using ray-casting algorithm registration problems volume x-ray image camera model x-ray images given. goal transformation aligns projection volume x-ray image ambiguity matching volume single projected image multiple x-ray images different projection angles often employed registration. cases goal transformation aligns x-ray image pairs denoted denotes index x-ray image. special euclidean group special euclidean group matrices corresponding translations rotations. tangent space described using algebra generators corresponding derivatives translation rotation along/around standard axes. element represented multiples generators figure policy network encoder decoder neural network centered projection agent’s location extracted x-ray image drr. extracted regions encoded using obtain feature vectors concatenated decoded obtain reward estimation. actions state obtained taking action state reward received taking action state discount factor controls importance future rewards. action space reward scheme deﬁned core problem policy speciﬁes optimal action taken state maximize long term reward action space make policy learnable deﬁne action space based x-ray projection geometry action correlated speciﬁc appearance change largely independent c-arm geometry. specifically transformation described image coordinate system origin upper left corner image axes along image edges axes perpendicular image deﬁne agent coordinate system orientation image coordinate system origin selected individually coordinate transform image coordinate system agent coordinate system denoted transformation describe agent coordinate system written action space deﬁned small movements tangent space e◦tt parameterized speciﬁcally action space contains actions positive negative movements along generators table layer conﬁgurations encoder/decoder cnns equivalent dilated fcns. parameters convolutional layers written convolution kernal size number feature maps. indicates layer input stride indicates ﬁlter kernel dilated times. convolutional layers zero padding. selu activation function applied layers except input output layers. column output size speciﬁes output sizes cnn. equivalent cause rotations respect center roi. center ensures action always cause visual change observation leading consistent mapping observation rewards different actions modeled neural network. propose network architecture encodes x-ray separately decodes jointly obtain estimated reward shown fig. table trained supervised learning data randomly sampled registration environment similar particular given pair data training data generated dofs including dofs agent’s origin corresponding location agent dofs transformation corresponding pose volume. ground truth rewards calculated following eqn. make learned reward function generalizable unseen data dofs need sufﬁciently sampled training prohibitively high computational cost. million samples needed cover training data dofs sampling requirement grows exponentially dof. propose dilated fcn-based training mechanism reduce training data first encoder decoder cnns converted equivalent dilated fcns. ﬁlter dilation technique introduced used make pixel output exactly produced using corresponding since actions need relatively small step size order achieve high accuracy step size translation step size degree rotation. deﬁnition action space ensures translation actions causes shift zooming rotation actions causes rotation object around agent’s origin. therefore image appearance change given action largely independent underlying c-arm geometry. note action terminating mdp. instead agent ﬁxed number steps reward system standard optimization target long term reward i.e. accumulation discounted future reward difﬁculty forging reward system directly associate immediate reward long term goal. registration however deﬁne distance-based reward system immediate reward tied improvement registration. reward scheme deﬁned reduction distance ground truth transformation agent coordinate system takes rotation translation coefﬁcients described eqn. units rotation translation radian distance impact rotation small. therefore scale rotation coefﬁcients balance impacts rotation translation. policy learning dilated since seek greedy policy maximizes immediate reward model reward function deep neural network shown fig. learned supervised learning. input network observation current state consists observed region ﬁxed size x-ray referred region interest agent centered projection origin rotation actions figure training reward network using dilated fcn. encoder decoder converted equivalent dilated fcns. densely overlapping rois encoded dense feature vector map. feature vector randomly shifted times simulate translations volume imaging plane. ground truth dense reward calculated shift combined transformation. euclidean loss comparing estimated ground truth rewards used training. receptive ﬁeld input images. layer layer correspondence dilated shown table training using dilated illustrated fig. since encoder encodes rois input image replace sampling agent’s origin. translation part creates shift replaced shifting encoded feature training. therefore dofs training data avoided using fcn-based training reducing number total dofs since complexity environment grows exponentially reducing signiﬁcantly improve training efﬁciency. ground truth reward needs calculated training following eqn. eqn. given x-ray/drr pair known agent coordinate system {ei} calculated rois within input image tracing pixel back volume. shift feature essentially adding translation equivalent updating shift represented distance action calculated using following eqn. roi. similarly distance action calculated following steps replacing note expensive computation matrix logarithms pre-calculated x-ray/drr pair depend shift. multi-agent system since x-ray images surgery interventions different field-of-view contain many structures match image many rois contain reliable visual cues registration therefore propose multi-agent system provide auto attention adaptively choose reliable rois registration. speciﬁcally policy network applied x-ray produce dense reward contains estimated rewards agents possible rois input images denoted index agent action. every agent maximum reward calculated action associated selected since anticipated reward selected action represents agent’s conﬁdence action. fig. shows strong correlation conﬁdence score quality corresponding image large conﬁdence score high spine soft tissue; severe occlusion presented medical devices occluded area conﬁdence scores. cbct data consists cbct x-ray images used reconstructing cbct. cbct data extracted x-ray/drr pairs. since number cbcts limited also generated pairs synthetic x-ray image additional training data pairs generated total training data consist data i.e. cbct data synthetic data. training performed nvidia titan using pytorch. compared training using proposed dilated fcn. training random rois extracted x-ray input ground truth rewards calculated used supervision. curves training loss correct action rate using cnn-based dilated fcn-based training shown fig. fcn-based training ﬁnished hours testing loss testing correct action rate comparison cnn-based training hours reached test loss testing correct action rate close performance fcn-based method after hours training. testing evaluate contribution multi-agent strategy tested agent-based method modes using single agent center image referred agt-s using proposed multi-agent strategy referred agt-m. apply proposed method registration x-ray images every step action obtained x-ray image obtained actions applied sequentially. also tested combination agt-m optimization-based method referred agtm-opt optimization using bobyqa optimizer applied starting result agt-m. compared agent-based method state-of-the-art optimizationbased methods. multiple similarity measures evaluated using cma-es optimizer spine registration reported achieve best performance. therefore evaluated cma-es optimization using parameters reported referred es-go es-gc respectively. registration error measured target registration error calculated root mean square error locations seven anatomical landmarks located spine vertebrae. figure left conﬁdence distribution agents producing correct wrong actions. right relation percentage correct action among selected action conﬁdence threshold used selecting action. tention mechanism selects agents certain conﬁdence threshold. determine threshold behavior conﬁdence score analyzed validation data. actions categorized correct wrong based impact registration fig. shows distribution conﬁdence scores agents producing correct wrong actions relation percentage correction action among selected actions conﬁdence threshold used selecting actions. based analysis selected conﬁdence threshold correct rate selected actions avoid scenario agents selected given test image less agents conﬁdence score threshold agents selected. agents selected denoted actions selected agents aggregated chordal mean obtain ﬁnal actions applied proposed method clinical application registration minimally invasive spine surgery aims registering spine cone beam x-ray images acquired different angles. challenging problem surgical objects like screws guide wires presented separately images creating severe image artifacts occlusion target object training minimally invasive spine surgery initial pose offset cbct x-ray images translation degrees rotation. therefore train agents perform registration starting within range. particular x-ray/drr pairs used training random rotation offset feature randomly shifted training. training data generated cbct data sets three-hold cross validation cbct data tested clinical data sets collected minimally invasive spine surgery. data contains cbct acquired before surgery x-ray images acquired surgery. ground truth registration manually annotated experts. data perturbations ground truth transformation randomly generated starting positions registration leading test cases. experiment results clinical data summarized table higher tres reported methods clinical data cbct data primarily three reasons ground truth registration clinical data manually annotated could bear error; complexity clinical data much higher cbct data agent-based methods agent trained without using real clinical data spine surgery. observed increased complexity heuristically selected used agt-s become even less reliable. result robustness agt-s degrades signiﬁcantly comparing cbct data. multi-agent system agt-m contrast achieved much higher robustness agt-s even though individual agent trained without using clinical data spine surgery demonstrating effectiveness multi-agent strategy dealing complex scenarios. paper formulated registration proposed multi-agent system solve challenging problem. multi-agent action aggregation scheme proposed drive registration inherent attention focus. addition dilated fcn-based training scheme proposed reduce number dofs need sampled training speeds training efﬁciency order magnitude. experiments cbct data clinical data proposed method shown able achieve signiﬁcantly higher robustness state-of-the-art registration methods. future works explore advantages provided proposed dilated fcn-based network structure general computer vision problems optical estimation metric learning. speciﬁcally unlike fcn-based optical pooling uppooling layers inherently make output insensitive small motion network structure ensures local image descriptor strictly follows input therefore potentially provide high accuracy motion estimation. addition property could utilized metric learning using triplet networks i.e. embeding rois feature vectors euclidean distances correlated physical distances rois. dilated based training scheme could general highly efﬁcient allowing training multiple displacements back propagation. currently investigation. table experiment results bi-plane registration test cases cbct data sets test cases clinical data sets. gross failure rate accounts test cases tre> median percentile percentile tres reported. cbct data testing ﬁrst performed cbct data sets three-fold cross validation typical size cbct data pixel spacing data pairs x-ray images apart randomly selected registration performed pair starting perturbation ground truth transformation within translation rotation leading test cases. note x-ray images cbct data relatively faint spine shown fig. experiment results summarized table optimization-based methods es-go es-gc resulted relatively high gross failure rate mainly image quality leads highly non-convex optimization problem using level similarity measures like comparison agt-m achieved much lower gross failure rate demonstrating robustness advantage agent-based method. comparison agt-s agt-m shows multi-agent strategy noticeably improve robustness aggregating information conﬁdent agents. comparison median shows agent-based method provides failure rate accuracy lower optimization-based methods. primarily discrete actions degree location information loss stride cnn. applying opt-local reﬁne result agt-m apt-m-opt achieved failure rate high accuracy.", "year": 2017}